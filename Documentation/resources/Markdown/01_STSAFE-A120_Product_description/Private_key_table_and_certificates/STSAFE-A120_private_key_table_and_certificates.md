# Private key table and leaf certificate(s) {#Private_key_table_and_leaf_certificates}

The **Private Key Table** in the STSAFE-A120 device is a critical component for managing private keys used in cryptographic operations such as signature generation and key establishment.

It consists of a fixed number of slots, each capable of securely storing a private key along with its associated attributes and usage policies.

## Private key Slots

- The private key table contains **6 slots** in total:
  - **5 static slots** stored in device non-volatile memory (User-NVM).
  - **1 ephemeral slot** stored in device volatile memory (RAM).

### Slot 0 (pre-provisioned by STMicroelectronics)

**Slot 0** is provisioned during device personalization and contains a private key used as the device's leaf private key.  
This key is associated with a leaf certificate pre-provisioned in user NVM slot 0, enabling secure authentication tied to a trusted certificate chain.

This setup enables the device to perform secure authentication and cryptographic operations tied to a trusted certificate chain.

### Additional Private Key Slots (Slots 1 to 4)

Slots 1 to 4 are available for application-specific private keys. They can be provisioned during personalization by ST or dynamically on demand by a host processor.  
When provisioned by STMicroelectronics during personalization, these slots come preloaded with private keys tailored to the customer's security requirements, ensuring secure and controlled deployment.

Alternatively, the host can generate keys in these slots (post-personalization) using the device’s **Generate Key** command.  
This command subject to slot access conditions and authorization flags.  
These flags can be configured as OTP by the host or pre-configured during device pre-provisioning for each slot.  
This dynamic provisioning capability allows for secure key lifecycle management, including key rotation or renewal, without requiring physical device replacement.

Slots 1 to 4 offer a secure and flexible key management framework that can be adapted to evolving application needs, either through initial provisioning by STMicroelectronics or secure on-demand provisioning by the host, enabling robust and scalable security architectures.

### Ephemeral Private Key Slot (Slot 255)
Ephemeral slot temporary store a private key used exclusively for key establishment (ECDH).  
Usage of this key is limited to a single operation (the ephemeral slot is erased).  
After a reset or a power cycle, this slot is also erased.


## Applicative Usage of Private Key Slots

| Slot Number | Type       | Usage Description                                                                                                  | Key Storage Location | Usage Limits & Controls                          |
|-------------|------------|--------------------------------------------------------------------------------------------------------------------|----------------------|-------------------------------------------------|
| 0           | Static     | Pre-provisioned private key for device identity; used for signature generation and authentication                  | User-NVM             | Usage limited by personalization; associated with leaf certificate in user NVM slot 0 |
| 1 to 4      | Static     | Available for application-specific private keys for signatures, key establishment, or other uses                   | User-NVM             | Usage limits by personalization or configurable; can be generated by host under access control |
| 255 (0xFF)  | Ephemeral  | Temporary private key used exclusively for key establishment (ECDH); erased after use, reset or device power cycle | RAM                  | Single-use key; cannot be used for signature generation |


## Key Attributes and Controls

- **Mode of Operation Flags**: Each slot has authorization flags controlling:
  - Whether signature generation over internal/external data is allowed.
  - Whether signature generation over externally provided data is allowed.
  - Whether key establishment operations are authorized.

- **Usage Limits**:
  - Static slots have configurable usage limits (number of allowed operations).
  - Ephemeral slot usage is limited to a single operation.

- **Change Rights**:
  - Authorization flags can be updated once during the device lifetime for static slots.
  - Ephemeral slot flags are mostly fixed except for "generate key" command access condition.

> **IMPORTANT:**  
> For security reasons, it is recommended to assign only one mode of operation per private key slot. 


## Device authentication & Leaf Certificate usage

The private key in Slot 0 is tightly coupled with a **leaf certificate stored in user NVM zone 0**.  
This certificate contains the corresponding public key.  
This public key is used by the host or external entities to authenticate a device by verifying the signature generated with the private key.  
This arrangement supports secure device identity verification and trusted communication in applications such as secure boot, TLS client authentication, or device attestation.


### Device authentication

Following scheme is typicaly used for accessories authentication:

@startuml
 
    skinparam ParticipantPadding 20
    skinparam BoxPadding 50
 
    !define DOC <size:20><&document></size>
    !define SIG <size:20><&pencil></size>
    !define KEY <size:20><&key></size>
    !define HSH <size:20><b>#</b></size>
 
    !define MESSAGE <i>Message</i>
    !define SIGNATURE <i>Digital_Signature</i>
    !define CHAL <i>Challenge</i>
    !define CERT <i>Certificate</i>
    !define KPUB <Color:$ST_GREEN>KEY</color><b><i>Dev_Kpub</i></b>
    !define KPRI <Color:$ST_PINK>KEY</color><b><i>Dev_Kpri</i></b>
    !define CA_KPUB <Color:$ST_YELLOW>KEY</color><b><i>CA_Kpub</i></b>
 
    'Define participant (define order = display order left to right)
 
    box Authenticator
    participant "Processor \n CA_KPUB" as RECEIVER
    end box
 
    box Device
    participant "Processor" as SENDER
    participant "<color:$ST_DARK_BLUE><b>STSAFE-A</b></color> \n <Color:$ST_PINK>KEY</color><Color:$ST_DARK_BLUE><b><i>Dev_Kpri</i></b>" as STSE $ST_YELLOW
    end box
 
    activate RECEIVER $ST_DARK_BLUE_25
        group Device certificate verification
            RECEIVER -> SENDER : Get CERT
            activate SENDER $ST_DARK_BLUE_25
            SENDER -> STSE : read zone 0
            activate STSE $ST_DARK_BLUE_25
            return CERT
            SENDER --> RECEIVER : CERT
            deactivate SENDER
            rnote over RECEIVER
            Verify certificate
            using CA_KPUB
            end note
            alt $ST_GREEN_25 <b>Certificate verification : <color:$ST_GREEN>PASS</color></b>
            rnote over RECEIVER
            certificate is valid
            end note
            else $ST_PINK_25 <b>Certificate verification : <color:$ST_PINK>FAIL</b>
            rnote over RECEIVER
            certificate is not valid
            end note
            end if
        end group
 
group Device authentication (if certificate is valid)
        RECEIVER -> SENDER : CHAL
        activate SENDER $ST_DARK_BLUE_25
        SENDER -> STSE : <b>ECDSA_Sign</b> (CHAL)
        deactivate SENDER
        activate STSE $ST_DARK_BLUE_25
        rnote over STSE
        Generate signature
        using KPRI
        (ECDSA sign)
        end note
        return SIGNATURE
        activate SENDER $ST_DARK_BLUE_25
 
        SENDER --> RECEIVER :SIGNATURE
        deactivate SENDER
       
        rnote over RECEIVER
        Verify signature
        using KPUB
        (ECDSA verify)
        end note
 
        alt $ST_GREEN_25 <b>Signature verification : <color:$ST_GREEN>PASS</color></b>
        rnote over RECEIVER
        ECDSA challenge Successfull
        end note
        else $ST_PINK_25 <b>Signature verification : <color:$ST_PINK>FAIL</b>
        rnote over RECEIVER
        ECDSA challenge Failed
        end note
        end if
    end group
@enduml

In above device authentication flow, the **Certificate Authority (CA)** serves as a trusted third party responsible for issuing and digitally signing certificates.  
These certificates bind a device’s public key to its unique identity, enabling the authenticator to trust that the device is genuine.  
The CA’s public key (CA_Kpub) is used by the authenticator to verify the certificate’s authenticity and integrity, ensuring it was issued by a legitimate authority and has not been altered.  
This verification step is critical to prevent attackers from impersonating devices with forged or invalid certificates.

Once the certificate is validated, the authentication process relies on **asymmetric cryptography**, which uses a pair of keys: a private key and a public key.  
The device securely stores its private key (Dev_Kpri) inside a tamper-resistant secure element (STSAFE-A), ensuring it never leaves the device or becomes exposed.  
The corresponding public key (Dev_Kpub) is included in the certificate and shared with the authenticator.

During authentication, the authenticator sends a random **challenge** to the device.  
The device uses its private key to generate a **digital signature** on this challenge.  
Because the private key is securely stored and never transmitted, only the legitimate device can produce a valid signature.  
The authenticator then verifies this signature using the device’s public key extracted from the validated certificate.

This **challenge-response mechanism** proves the device’s identity securely without exposing sensitive key material.  
The combination of certificate validation by the CA and cryptographic signature verification ensures a robust authentication process that protects against impersonation, replay attacks, and unauthorized access, thereby maintaining the integrity and security of the system.

### X.509 Leaf Certificate Structure

Each STSAFE-A device is provisioned with at least one unique X.509 certificate, which binds the device’s public key to its identity.  
The certificate contains several fields, including:

| X.509 Field | Description |
| :---: | :--- |
| Version | Certificate version (X.509 v3) |
| Serial Number | Unique integer assigned by the CA |
| Algorithm ID | Algorithm used to sign the certificate |
| Issuer | Entity that issued the certificate |
| Validity | Time interval certificate is valid |
| Subject | Entity associated with the public key |
| Subject Public Key Info | Public key and algorithm details |
| Issuer Unique Identifier | Optional issuer info |
| Subject Unique Identifier | Optional subject info |
| Extensions | Optional extra info |
| Signature | Digital signature from CA’s private key |

The certificate’s digital signature is generated from a hash of the certificate data, ensuring integrity and authenticity.  
Any modification to the certificate data will result in signature verification failure, preventing tampering and unauthorized changes.  
Before verifying its digital signature, the certificate data can be used to verify the certicate has not been revoked or expired.

### STSAFE-A120 Certificate Authority and Public Key Infrastructure (PKI)

A Certificate Authority (CA) is a trusted organization responsible for issuing and managing certificates.  
In embedded systems, Certificate Authorities (CAs) may include secure element manufacturers (such as STMicroelectronics), OEMs, or third-party providers.

To support large-scale deployments, a hierarchical PKI is used.  
A root CA issues intermediate CA certificates, which in turn sign device certificates.  
This creates a certificate chain, establishing a chain of trust from the root CA to each device.

<img src="Certificate_chain.png" alt="X509 Certificate chain" style="width:600px;"/>

PKI encompasses CAs, key pairs, and certificates, forming the backbone of secure device identity and authentication.

### STMicroelectronics PKI for SPL05 Personalization Profile

All STSAFE-A devices are pre-provisioned in STMicroelectronics’ secure factory with a unique key pair and certificate (stored through slot 0 and NVM zone 0), forming part of the STMicroelectronics PKI.

The PKI hierarchy begins with a self-signed root certificate.  
Each STSAFE-A120 SPL05 device receives a unique private key and a leaf certificate signed by the root CA.

<img src="SPL0x_PKI.png" alt="SPL05 Public Key Infrastructure" style="width:800px;"/>

> **_IMPORTANT:_**  
> All STSAFE-A120 SPLx devices share the same PKI and CA.  
> Devices are differentiated by their serial numbers. OEMs using SPLx samples for production should regenerate their own leaf certificates or carefully track serial numbers to maintain security.

#### STMicroelectronics PKI for Custom Personalization Profiles

For OEMs requiring tailored security, ST offers a custom two-level PKI service for orders of 5,000 devices or more.

<img src="Cust_ST_PKI.png" alt="Custom ST CA Public Key Infrastructure" style="width:800px;"/>

Custom PKI features include:
- Dedicated root CA for each OEM profile
- Customizable certificate content (excluding serial number and public key)
- Personalized device profiles with custom keys and configurations

#### Third-party PKI with STMicroelectronics as Intermediate CA

Intermediate CAs provide additional flexibility and security, allowing different organizations to manage their own certificate hierarchies.  
For example, STMicroelectronics can act as an intermediate CA for the Wireless Power Consortium.

<img src="ST_as_int_CA.png" alt="Custom ST CA Public Key Infrastructure" style="width:800px;"/>

Compared to the standard ST PKI, third-party PKI with ST as intermediate CA offers:
- Dedicated intermediate CA per profile
- Customizable certificate content
- Personalized device profiles with pre-provisioned keys

#### OEM and Third-party PKI Integration

SPL05 devices can be reassigned to OEM or third-party PKI through a certificate rotation process, enabling flexible integration with existing security infrastructures.

<img src="leaf-certificate_rotation.png" alt="Custom ST CA Public Key Infrastructure" style="width:800px;"/>

This flexibility allows OEMs to leverage in-house or third-party services for:
- Security lifecycle management
- Identity and Access Management (IAM)
- Cloud security integration
- Code signing for secure software deployment

For more information, see ST Partners Program:
- [Kudelski IoT](https://www.st.com/content/st_com/en/partner/partner-program/partnerpage/Kudelski-IoT.html)
- [KeyFactor](https://www.st.com/content/st_com/en/partner/partner-program/partnerpage/Keyfactor.html)
- [Commscope](https://www.st.com/content/st_com/en/partner/partner-program/partnerpage/commscope.html)

#### Third-party Certification Programs (WPC Qi / Ki Example)

STSAFE-A supports third-party certification programs, such as Qi wireless charging and Ki cordless kitchen certification from the Wireless Power Consortium (WPC).  
Qi certification ensures wireless charging products meet stringent safety and performance standards, while Ki certification applies similar standards for kitchen appliances.

![QI applicative scenario](Qi_authentication.png)
![KI applicative scenario](Ki_authentication.png)

> **NOTE:**  
> To achieve Qi or Ki certification, products must undergo authorized laboratory testing to verify compliance with WPC requirements.

---

© 2025 STMicroelectronics – All rights reserved